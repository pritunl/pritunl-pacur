targets=(
    "almalinux-8"
    "almalinux-9"
    "almalinux-10"
    "amazonlinux-2023"
    "oraclelinux-8"
    "oraclelinux-9"
    "oraclelinux-10"
)
pkgname="pritunl-openvpn-dco-dkms"
pkgver="0.2.20251017"
pkgrel="1"
pkgdesc="OpenVPN Data Channel Offload DKMS kernel module"
pkgdesclong=(
    "OpenVPN Data Channel Offload DKMS kernel module"
)
maintainer="Pritunl <contact@pritunl.com>"
arch="amd64"
license=("GPLv2")
section="utils"
priority="optional"
url="https://community.openvpn.net/"
depends:yum=(
    "dkms"
    "kernel-devel"
)
optdepends:yum=(
    "kernel-uek-devel"
)
makedepends:yum=(
    "make"
)
provides=(
    "${pkgname}"
    "openvpn-dco-dkms"
)
conflicts=(
    "${pkgname}"
    "openvpn-dco-dkms"
)
sources=(
    "https://github.com/OpenVPN/ovpn-dco/archive/refs/tags/v${pkgver}.tar.gz"
)
hashsums=(
    "af88c9bc73b350e0cada9aa5b21c5d4b598f9a9868f0b78b2d06026183a67032"
)

build() {
    cd ${srcdir}/ovpn-dco-${pkgver}
}

package() {
    cd ${srcdir}/ovpn-dco-${pkgver}

    mkdir -p ${pkgdir}/usr/src/ovpn-${pkgver}

    cp -a compat-include ${pkgdir}/usr/src/ovpn-${pkgver}/
    cp -a drivers ${pkgdir}/usr/src/ovpn-${pkgver}/
    cp -a include ${pkgdir}/usr/src/ovpn-${pkgver}/
    cp -a linux-compat.h ${pkgdir}/usr/src/ovpn-${pkgver}/
    cp -a Makefile ${pkgdir}/usr/src/ovpn-${pkgver}/
    cp -a gen-compat-autoconf.sh ${pkgdir}/usr/src/ovpn-${pkgver}/

    tee "${pkgdir}/usr/src/ovpn-${pkgver}/dkms.conf" << 'EOF'
PACKAGE_NAME="ovpn"
PACKAGE_VERSION="${pkgver}"
AUTOINSTALL="yes"

BUILT_MODULE_NAME[0]="ovpn-dco-v2"
BUILT_MODULE_LOCATION[0]="drivers/net/ovpn-dco"
DEST_MODULE_LOCATION[0]="/kernel/drivers/net"

MAKE[0]="make KERNEL_SRC=$kernel_source_dir"
CLEAN="make clean KERNEL_SRC=$kernel_source_dir"
EOF
}

postinst() {
    dkms add -m ovpn -v ${pkgver} --rpm_safe_upgrade || true
    dkms build -m ovpn -v ${pkgver} || true
    dkms install -m ovpn -v ${pkgver} --force || true
}

prerm() {
    dkms remove -m ovpn -v ${pkgver} --all --rpm_safe_upgrade || true
}
