targets=(
    "almalinux-9"
    "almalinux-10"
    "oraclelinux-9"
    "oraclelinux-10"
    "ubuntu-noble"
)
pkgname="pritunl-cloud"
pkgver="2.0.3615.44"
pkgrel="1"
pkgdesc="Pritunl Cloud"
pkgdesclong=(
    "Pritunl Cloud"
)
maintainer="Pritunl <contact@pritunl.com>"
arch="amd64"
license=("custom")
section="utils"
priority="optional"
url="https://github.com/pritunl/${pkgname}"
depends:yum=(
    "iptables"
    "net-tools"
    "ipset"
    "ipvsadm"
    "xorriso"
)
depends:apt=(
    "iptables"
    "net-tools"
    "ipset"
    "ipvsadm"
    "xorriso"
)
optdepends:yum=(
    "qemu-kvm"
    "qemu-img"
    "swtpm"
    "swtpm-tools"
)

makedepends:yum=(
    "git"
)
makedepends:apt=(
    "git"
)
provides=("${pkgname}")
conflicts=(
    "${pkgname}"
)
sources=(
    "${url}/archive/refs/tags/${pkgver}.tar.gz"
)
hashsums=(
    "77afdc984fcf2e1b6b9f649b2864ab2e64ebb29e063eb2d81c852b4fd9d61216"
)
backup=(
    "etc/${pkgname}.json"
    "var/log/${pkgname}.log"
    "var/log/${pkgname}.log.1"
)

build() {
    mkdir -p /go/src/github.com/pritunl
    mv "${srcdir}/${pkgname}-${pkgver}" /go/src/github.com/pritunl/${pkgname}
    cd /go/src/github.com/pritunl/${pkgname}
    go get
    go install

    cd /go/src/github.com/pritunl/${pkgname}/agent
    CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -ldflags '-extldflags "-static"' -v -o agent-static
    mv ./agent-static /go/bin/${pkgname}-agent
    CGO_ENABLED=0 GOOS=freebsd GOARCH=amd64 go build -v -o agent-bsd
    mv ./agent-bsd /go/bin/${pkgname}-agent-bsd

    cd /go/src/github.com/pritunl/${pkgname}/redirect
    CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -v -o redirect
    mv ./redirect /go/bin/${pkgname}-redirect
}

package() {
    mkdir -p ${pkgdir}/usr/bin
    cp /go/bin/${pkgname} ${pkgdir}/usr/bin/${pkgname}
    chmod 755 ${pkgdir}/usr/bin/${pkgname}
    cp /go/bin/${pkgname}-redirect ${pkgdir}/usr/bin/${pkgname}-redirect
    chmod 755 ${pkgdir}/usr/bin/${pkgname}-redirect
    cp /go/bin/${pkgname}-agent ${pkgdir}/usr/bin/${pkgname}-agent
    chmod 755 ${pkgdir}/usr/bin/${pkgname}-agent
    cp /go/bin/${pkgname}-agent-bsd ${pkgdir}/usr/bin/${pkgname}-agent-bsd
    chmod 755 ${pkgdir}/usr/bin/${pkgname}-agent-bsd

    mkdir -p ${pkgdir}/usr/share/${pkgname}/www
    cp -r /go/src/github.com/pritunl/${pkgname}/www/dist/. ${pkgdir}/usr/share/${pkgname}/www/

    mkdir -p ${pkgdir}/etc
    echo "{}" > ${pkgdir}/etc/${pkgname}.json
    chmod 600 ${pkgdir}/etc/${pkgname}.json

    mkdir -p ${pkgdir}/etc/systemd/system
    cp /go/src/github.com/pritunl/${pkgname}/tools/pritunl-cloud.service ${pkgdir}/etc/systemd/system
    cp /go/src/github.com/pritunl/${pkgname}/tools/pritunl-cloud-redirect.socket ${pkgdir}/etc/systemd/system
    cp /go/src/github.com/pritunl/${pkgname}/tools/pritunl-cloud-redirect.service ${pkgdir}/etc/systemd/system

    mkdir -p ${pkgdir}/var/log
    touch ${pkgdir}/var/log/${pkgname}.log
    touch ${pkgdir}/var/log/${pkgname}.log.1
}

postinst() {
    useradd -r -s /sbin/nologin -c 'Pritunl Cloud web server' pritunl-cloud-web &> /dev/null || true
    systemctl daemon-reload &> /dev/null || true
    systemctl is-active --quiet pritunl-cloud && systemctl restart pritunl-cloud || true
}

postrm() {
    systemctl daemon-reload &> /dev/null || true
}
