targets=(
    "almalinux-8"
    "almalinux-9"
    "almalinux-10"
    "amazonlinux-2"
    "amazonlinux-2023"
    "oraclelinux-7"
    "oraclelinux-8"
    "oraclelinux-9"
    "oraclelinux-10"
)
pkgname="pkcs11-helper"
pkgver="1.31.0"
pkgrel="2"
pkgdesc="A library for using PKCS#11 providers"
pkgdesclong=(
    "pkcs11-helper is a library that simplifies the interaction with PKCS#11"
    "providers for end-user applications using a simple API and optional"
    "OpenSSL engine. The library allows using multiple PKCS#11 providers at"
    "the same time, enumerating available token certificates, or selecting a"
    "certificate directly by serialized id, handling card removal and card"
    "insert events, handling card re-insert to a different slot, supporting"
    "session expiration and much more all using a simple API."
)
maintainer="Pritunl <contact@pritunl.com>"
arch="amd64"
license=("GPLv2")
section="utils"
priority="optional"
url="https://github.com/OpenSC/pkcs11-helper"
depends:yum=(
    "automake"
    "openssl-devel"
)
makedepends:yum=(
    "gcc"
    "doxygen"
    "graphviz"
    "openssl-devel"
)
makedepends:amazonlinux-2=(
    "gcc"
    "doxygen"
    "graphviz"
    "perl-core"
    "perl-IPC-Cmd"
    "zlib-devel"
)
makedepends:oraclelinux-7=(
    "gcc"
    "doxygen"
    "graphviz"
    "perl-core"
    "perl-IPC-Cmd"
    "zlib-devel"
)
provides=(
    "${pkgname}"
    "${pkgname}-devel"
)
conflicts=(
    "${pkgname}"
    "${pkgname}-devel"
)
sources=(
    "https://github.com/OpenSC/pkcs11-helper/releases/download/pkcs11-helper-${pkgver}/pkcs11-helper-${pkgver}.tar.bz2"
    "https://github.com/openssl/openssl/releases/download/openssl-3.0.19/openssl-3.0.19.tar.gz"
)
hashsums=(
    "46f0067bccd7be2c28f88b8bca775172b9e52fb6fc1280b44ca8bb831433fef9"
    "fa5a4143b8aae18be53ef2f3caf29a2e0747430b8bc74d32d88335b94ab63072"
)

build() {
    cd "${srcdir}/pkcs11-helper-${pkgver}"

    ./configure --disable-static --prefix=/usr
    make
}

build:amazonlinux-2() {
    cd "${srcdir}/openssl-3.0.19"
    ./config \
        no-shared \
        no-pinshared \
        --prefix="${srcdir}/openssl-static" \
        --openssldir="${srcdir}/openssl-static/ssl" \
        --libdir=lib \
        -fPIC
    make -j$(nproc)
    make install_sw

    cd "${srcdir}/pkcs11-helper-${pkgver}"

    export PKG_CONFIG_PATH="${srcdir}/openssl-static/lib/pkgconfig"
    ./configure --disable-static --prefix=/usr
    make
}

build:oraclelinux-7() {
    cd "${srcdir}/openssl-3.0.19"
    ./config \
        no-shared \
        no-pinshared \
        --prefix="${srcdir}/openssl-static" \
        --openssldir="${srcdir}/openssl-static/ssl" \
        --libdir=lib \
        -fPIC
    make -j$(nproc)
    make install_sw

    cd "${srcdir}/pkcs11-helper-${pkgver}"

    export PKG_CONFIG_PATH="${srcdir}/openssl-static/lib/pkgconfig"
    ./configure --disable-static --prefix=/usr
    make
}

package() {
    cd "${srcdir}/pkcs11-helper-${pkgver}"
    make DESTDIR=${pkgdir} install
}

postinst:yum() {
    /usr/sbin/ldconfig
}

postrm:yum() {
    /usr/sbin/ldconfig
}
